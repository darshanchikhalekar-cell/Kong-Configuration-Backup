---
- name: Kong Configuration Backup using decK
  hosts: all
  become: yes
  gather_facts: yes

  vars:
    kong_admin_url: "http://localhost:8001"
    remote_backup_path: /tmp
    local_clone_path: /tmp/kong_config_repo
    repo_url: "https://github.com/<your-username>/Kong-Configuration-Backup.git"
    timestamp: "{{ ansible_date_time.date }}_{{ ansible_date_time.time | replace(':','-') }}"
    backup_file: "deck_backup_{{ inventory_hostname }}_{{ timestamp }}.yaml"

  tasks:

    - name: Validate workspace input for specific backup
      fail:
        msg: "Workspace name must be provided when backup_type is 'specific'"
      when: backup_type == "specific" and (workspace_name is not defined or workspace_name == "")

    - name: Take FULL backup using decK
      shell: >
        deck dump --kong-addr {{ kong_admin_url }}
        -o {{ remote_backup_path }}/{{ backup_file }}
      when: backup_type == "full"

    - name: Take SPECIFIC workspace backup using decK
      shell: >
        deck dump --kong-addr {{ kong_admin_url }}
        --workspace {{ workspace_name }}
        -o {{ remote_backup_path }}/{{ backup_file }}
      when: backup_type == "specific"

    - name: Fetch backup to AWX
      fetch:
        src: "{{ remote_backup_path }}/{{ backup_file }}"
        dest: "/tmp/"
        flat: yes

    - name: Remove remote backup file
      file:
        path: "{{ remote_backup_path }}/{{ backup_file }}"
        state: absent

    # -------------------------
    # Git Operations
    # -------------------------

    - name: Remove old local clone if exists
      delegate_to: localhost
      become: false
      file:
        path: "{{ local_clone_path }}"
        state: absent

    - name: Clone repository
      delegate_to: localhost
      become: false
      git:
        repo: "{{ repo_url }}"
        dest: "{{ local_clone_path }}"
        version: main
        force: yes

    - name: Ensure backup folder exists
      delegate_to: localhost
      become: false
      file:
        path: "{{ local_clone_path }}/deck_backups/{{ backup_type }}"
        state: directory

    - name: Ensure workspace folder exists (if specific)
      delegate_to: localhost
      become: false
      file:
        path: "{{ local_clone_path }}/deck_backups/specific/{{ workspace_name }}"
        state: directory
      when: backup_type == "specific"

    - name: Copy FULL backup into repo
      delegate_to: localhost
      become: false
      copy:
        src: "/tmp/{{ backup_file }}"
        dest: "{{ local_clone_path }}/deck_backups/full/{{ backup_file }}"
      when: backup_type == "full"

    - name: Copy SPECIFIC backup into repo
      delegate_to: localhost
      become: false
      copy:
        src: "/tmp/{{ backup_file }}"
        dest: "{{ local_clone_path }}/deck_backups/specific/{{ workspace_name }}/{{ backup_file }}"
      when: backup_type == "specific"

    - name: Configure Git identity
      delegate_to: localhost
      become: false
      shell: |
        git config user.name "AWX Automation"
        git config user.email "awx@demo.local"
      args:
        chdir: "{{ local_clone_path }}"

    - name: Git add changes
      delegate_to: localhost
      become: false
      command: git add deck_backups/
      args:
        chdir: "{{ local_clone_path }}"

    - name: Commit changes
      delegate_to: localhost
      become: false
      command: git commit -m "decK {{ backup_type }} backup from {{ inventory_hostname }} on {{ timestamp }}"
      args:
        chdir: "{{ local_clone_path }}"
      ignore_errors: yes

    - name: Push changes securely
      delegate_to: localhost
      become: false
      shell: >
        git push https://<your-username>:${GITHUB_TOKEN}@github.com/<your-username>/Kong-Configuration-Backup.git
      args:
        chdir: "{{ local_clone_path }}"
      environment:
        GITHUB_TOKEN: "{{ github_token }}"
